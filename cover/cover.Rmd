---
title: Playground for PNAS cover graphic 
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "fig/", cache = TRUE, 
                      autodep = TRUE, cache.comments = TRUE,
                      message = FALSE, warning = FALSE)

library(covidcast)
library(epitools)
library(ggplot2)
library(dplyr)
library(purrr)
```

```{r get-data, eval = FALSE}
sources <- c("jhu-csse", 
             "doctor-visits", 
             "fb-survey", 
             "google-symptoms")

signals <- c("confirmed_7dav_incidence_prop",
             "smoothed_adj_cli",
             "smoothed_whh_cmnty_cli",
             "sum_anosmia_ageusia_smoothed_search")

start <- "2020-04-15"
end <- "2021-10-25"

Select <- function(x, ...) { 
  if (nrow(x) == 0) x
  else select(x, ...) 
}

x <- covidcast_signals(
  sources, signals,
  start, end, 
  geo_type = "state"
) %>% map(function(df) df %>% 
            Select(data_source, signal, geo_value, time_value, value))
```

```{r save-all, eval = FALSE}
save(list = ls(), file = "all.rda")
```

```{r load-all}
load(file = "all.rda")
```

```{r trend-plots}
names <- c("Reported COVID cases", 
           "COVID symptoms in medical claims", 
           "Self-reported COVID symptoms in surveys",
           "Searches for COVID symptoms on Google")
colors <- c("#FFFFFF", "#E69F00", "#56B4E9", "#CC79A7")

g <- vector(mode = "list", length = length(x))
delta <- 1/500
alpha <- 0.35
ylim <- c(-0.05, 1.05 + 50 * delta)

for (i in 1:length(x)) {
  g[[i]] <- x[[i]] %>%
    filter(geo_value %in% tolower(state.abb)) %>%
    mutate(geo_num = as.integer(as.factor(geo_value))) %>%
    group_by(geo_value) %>%
    mutate(value = (value - Min(value)) / (Max(value) - Min(value)) + 
             delta * (geo_num - 1)) %>%
    ungroup() %>%
    ggplot(aes(x = time_value, y = value, group = geo_value)) +
    labs(y = names[i]) + coord_cartesian(ylim = ylim) +
    geom_line(alpha = 0.5, color = colors[i]) + theme_void() +
    theme(panel.background = element_rect(fill = "black"),
          axis.title.y = element_text(color = colors[i], angle = 90,
                                      margin = margin(l = 10, r = -15)))
}

pdf(file = "cover-graphic.pdf", width = 15, height = 15)
do.call(gridExtra::marrangeGrob, list(g, nrow = 5, ncol = 1))
graphics.off()
```
